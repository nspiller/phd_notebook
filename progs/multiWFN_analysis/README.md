# Analysis of QM part with multiWFN
This workflow describes the analysis of QM part of a QMMM calculation.
It focuses on the electron distribution among the metals.
The partitioning of the physical space can be done in two ways
	- fuzzy (e.g. Hirshfeld or Becke method TODO: cite)
	- discrete (Bader's QTAIM method TODO: cite)

Within the chosen partitioning the following is analyzed:
- spin population
- atomic charges
- bond order and atomic valence 
- atomic contributions to orbitals (most meaningful for localized orbitals)

The following files and programs are required:
- geometry/basis set/wave function file (GBW) from [ORCA quantum chemistry program](https://orcaforum.kofo.mpg.de/)
- `orca_2mkl` utility from ORCA
- [MultiWFN program](http://sobereva.com/multiwfn/) v3.7

Optional are:
- `orca_loc` utility to localize orbitals (assuming ORCA v4.2 input format)
- ORCA output file for automatic determination of orbital energy window  for localization
- Chemshell `qmatoms` and `xplor.psf` file for easy mapping of atom indices

# quick start: orca1.out and orca1.gbw
- run in this order
	- `write_orca_loc_input.py`
	- `orca_loc orca_loc_alpha.inp` 
	- `orca_loc orca_loc_beta.inp`
	- `orca_2mkl loc -molden` 
	- `Multiwfn loc.molden.input < multi_hirsh.inp | tee multi_hirsh.out`
	- `parse_multiwfn.py multi_hirsh.out`
	

# Step-by-Step guide
## step 1: convert GBW to molden file
`MultiWFN` can read the wave function in a molden file generated by the `orca_2mkl` utility.

### optional: localize orbitals in GBW
If you want analyse the localized orbitals als well, 
you should localize the orbitals first with the `orca_loc` utility. 

- generate input files for `orca_loc` utility
	- Option 1: Run `write_orca_loc_input.py` to generate files automatically. This will read in ORCA output file and get indices for occupied orbitals with an energy higher than 1 Ha.
	- Option 2: Modify `orca_loc_alpha.inp` and `orca_loc_beta.inp` (note: `orca_loc` inp format changed in ORCA v4.2)
		- ranges for alpha and beta orbitals (these numbers differ for non-singlets)
		- name of initial `*.gbw` (only `orca_loc_alpha.inp`)
		- preferred localization method 
- Run `orca_loc orca_loc_alpha.inp` 
- Run `orca_loc orca_loc_beta.inp`

### create molden file from GBW
- run `orca_2mkl $BASENAME -molden` (creates `$BASENAME.molden.input`, default: `BASENAME=loc`)

# step 2: analyze molden file with MultiWFN
Decide on either the fuzzy or discrete method to partitioning the physical space.
1. Fuzzy space analysis is cheaper (56 atoms: 5 min on 4 cores), because it uses predefined densities spherical.
This can lead to trouble for atoms in different and/or anisotropic environments. Because the method uses
atomic densities, each point in space belongs with a certain weight to every atom.
2. (TODO: Bader defines the volume around an atom based on the surface of minimal electron density between two atoms.
This step takes significantly longer (56 atoms: 12 h on 4 cores). It accounts for different chemical environments, because the volumes can take any possible shape.
Each point in space belongs to exactly one atom, Bader leads to a discrete partitioning.)

The following files will be generated:
- `multi_*.out` contains
	- atomic charges (for Hirshfeld: both Hirshfeld and CM5)
	- atomic alpha and beta spin population
	- specific to `multi_bader.out`
		- assingment of basins to atoms (assumed here that mapping is clear)
- `orbcomp.txt` contains
	- compositions of alpha and beta orbitals (beta starts after alpha)
	- numbers are either atoms (Hirshfeld) or basins (Bader)
- `LIDI.txt` contains
	- localization and delocalization indices for alpha and beta
	- numbers are either atoms (Hirshfeld) or basins (Bader)

### run MultiWFN
- run either 
	- TODO: `Multiwfn $BASENAME.molden.input < multi_bader.inp | tee multi_bader.out` or 
	- `Multiwfn $BASENAME.molden.input < multi_hirsh.inp | tee multi_hirsh.out`

### analyze MultiWFN output
- run `parse_multiwfn.py multi_*.out`
